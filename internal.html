<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DPR — Internal Assessment (Gold / Art / EIS) + Expanded & Rationale</title>
<meta name="color-scheme" content="light only" />
<style>
  :root{
    --bg1:#667eea; --bg2:#764ba2; --ink:#2c3e50; --muted:#666; --card:#fff; --edge:#e1e8ed;
    --acc:#667eea; --panel:#f8f9fa;
  }
  *{box-sizing:border-box}
  body{margin:0; padding:20px; min-height:100vh; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
       background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);}
  .container{max-width:1100px; margin:0 auto; background:var(--card); border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,.12); overflow:hidden}
  .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:#fff; padding:28px}
  .header h1{margin:0 0 6px; font-weight:300; font-size:2rem}
  .header p{margin:0; opacity:.92}
  .form-container{padding:26px}
  .question-group{margin-bottom:20px; padding:18px; background:var(--panel); border-radius:14px; border-left:5px solid var(--acc)}
  .question-group h3{margin:0 0 10px; color:var(--ink); font-size:1.05rem}
  .help{margin:6px 0 12px; color:#556; font-size:.95rem}
  .input-group{margin:10px 0}
  .input-group label{display:block; margin-bottom:6px; color:#445; font-weight:600}
  input[type="text"], input[type="number"], select{
    width:100%; padding:12px 14px; border:2px solid var(--edge); border-radius:10px; font-size:1rem; background:#fff
  }
  input:focus, select:focus{outline:none; border-color:var(--acc)}
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:980px){.grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}
  .check-card{display:flex; align-items:center; gap:10px; padding:12px; background:#fff; border:2px solid var(--edge); border-radius:12px; cursor:pointer}
  .check-card:hover{border-color:var(--acc); background:#f0f2ff}
  .pill-group{display:flex; flex-wrap:wrap; gap:10px}
  .pill{position:relative}
  .pill input{display:none}
  .pill label{display:inline-block; padding:10px 14px; border:2px solid var(--edge); background:#fff; border-radius:999px; cursor:pointer; font-weight:600; font-size:.95rem}
  .pill input:checked + label{background:var(--acc); color:#fff; border-color:var(--acc)}
  .submit-btn{width:100%; padding:16px; background:linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%);
              color:#fff; border:none; border-radius:12px; font-size:1.05rem; font-weight:800; cursor:pointer}
  .toolbar{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  .btn{padding:10px 14px; border:2px solid var(--edge); background:#fff; border-radius:12px; cursor:pointer; font-weight:700}
  .btn.secondary{background:#f7f7ff}
  .result{display:none; padding:24px; background:var(--panel); border-radius:16px; margin-top:18px}
  .result.show{display:block}
  .cards{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:16px}
  @media (max-width:900px){.cards{grid-template-columns:1fr}}
  .investment-card{background:#fff; padding:16px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); border:1px solid #eef1f5}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e6e8ef; border-radius:999px; font-size:.82rem}
  .icon{font-size:1.6rem}
  .progress{height:10px; background:#eef1f7; border-radius:999px; overflow:hidden; margin:10px 0 8px}
  .bar{height:100%; width:0%}
  .bar.good{background:linear-gradient(90deg,#a7f3d0,#10b981)}
  .bar.mid{background:linear-gradient(90deg,#fde68a,#f59e0b)}
  .bar.low{background:linear-gradient(90deg,#fecaca,#ef4444)}
  .small{font-size:.9rem; color:#445}
  .disclaimer{margin-top:10px; font-size:.9rem; color:#4a5568}
  .inputs-recap{background:#fff; border:1px solid #eef1f5; border-radius:12px; padding:12px; margin:10px 0}
  .inputs-recap ul{margin:0; padding-left:18px}
  .inputs-recap li{margin:4px 0}
  .focus-overview{margin-top:12px}
  .tag{display:inline-block; margin:4px 6px 0 0; padding:6px 10px; border-radius:999px; border:1px solid #e6e8ef; background:#fff; font-size:.85rem}
  .report{margin-top:18px; background:#fff; border:1px solid #eef1f5; border-radius:12px; padding:12px}
  table{width:100%; border-collapse:collapse; font-size:.92rem}
  thead th{position:sticky; top:0; background:#f4f6fb; z-index:1}
  th, td{border-bottom:1px solid #f0f2f7; padding:8px 10px; text-align:left; white-space:nowrap}
  tbody tr:hover{background:#fafbff}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .right{text-align:right}
  .muted{color:#6b7280}
  .hl{background:#f8f6ff}
  .rationale{display:grid; gap:12px; grid-template-columns:repeat(3,minmax(0,1fr)); margin-top:10px}
  @media (max-width:900px){.rationale{grid-template-columns:1fr}}
  .card-lite{background:#fff; border:1px solid #eef1f5; border-radius:12px; padding:12px}
  .list{margin:6px 0 0 18px}
</style>
</head>
<body>
  <div class="container" role="main">
    <div class="header">
      <h1>De Pointe Research</h1>
      <p>Internal Assessment — recommends only Gold, Art or EIS + Weighting Report</p>
    </div>

    <div class="form-container">
      <form id="investmentForm" novalidate>
        <p class="help">Tick any areas of focus for context. Final recommendations list only <strong>Gold, Art or EIS</strong>. Results are illustrative, not advice.</p>

        <!-- Capital -->
        <section class="question-group">
          <h3>Capital</h3>
          <div class="grid cols-2">
            <div class="input-group">
              <label for="budget">Indicative Amount (£)</label>
              <input id="budget" name="budget" type="number" inputmode="decimal" min="0" step="1000" placeholder="e.g., 25,000" />
            </div>
            <div class="input-group">
              <label for="income-need">Income Need</label>
              <select id="income-need" name="incomeNeed">
                <option value="none">No income needed</option>
                <option value="low">Low 1 to 3 percent</option>
                <option value="mid">Mid 3 to 6 percent</option>
                <option value="high">High 6 percent plus</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Focus Areas (expanded) -->
        <section class="question-group">
          <h3>Focus Areas (select all that apply)</h3>
          <div class="grid cols-4" role="group" aria-label="Focus areas">
            <!-- Traditional -->
            <label class="check-card"><input type="checkbox" name="focus" value="stocks" />Stocks</label>
            <label class="check-card"><input type="checkbox" name="focus" value="bonds" />Bonds</label>
            <label class="check-card"><input type="checkbox" name="focus" value="etfs" />ETFs / Index Funds</label>
            <label class="check-card"><input type="checkbox" name="focus" value="dividend" />Dividend Equity</label>
            <label class="check-card"><input type="checkbox" name="focus" value="smallCaps" />Small Caps</label>
            <label class="check-card"><input type="checkbox" name="focus" value="emEquity" />EM Equity</label>
            <label class="check-card"><input type="checkbox" name="focus" value="emDebt" />EM Debt</label>
            <label class="check-card"><input type="checkbox" name="focus" value="reits" />REITs</label>
            <label class="check-card"><input type="checkbox" name="focus" value="property" />Direct Property</label>

            <!-- Alternatives / Private -->
            <label class="check-card"><input type="checkbox" name="focus" value="infrastructure" />Infrastructure</label>
            <label class="check-card"><input type="checkbox" name="focus" value="renewables" />Renewable Infrastructure</label>
            <label class="check-card"><input type="checkbox" name="focus" value="hedgeFunds" />Hedge Funds</label>
            <label class="check-card"><input type="checkbox" name="focus" value="privateCredit" />Private Credit</label>
            <label class="check-card"><input type="checkbox" name="focus" value="pe" />Private Equity</label>
            <label class="check-card"><input type="checkbox" name="focus" value="vc" />Venture Capital</label>
            <label class="check-card"><input type="checkbox" name="focus" value="structured" />Structured Notes</label>

            <!-- Commodities / real assets -->
            <label class="check-card"><input type="checkbox" name="focus" value="commodities" />Commodities (broad)</label>
            <label class="check-card"><input type="checkbox" name="focus" value="gold" />Gold</label>
            <label class="check-card"><input type="checkbox" name="focus" value="silver" />Silver</label>
            <label class="check-card"><input type="checkbox" name="focus" value="platinum" />Platinum</label>
            <label class="check-card"><input type="checkbox" name="focus" value="art" />Art</label>
            <label class="check-card"><input type="checkbox" name="focus" value="whisky" />Whisky / Wine</label>
            <label class="check-card"><input type="checkbox" name="focus" value="carbon" />Carbon Credits</label>

            <!-- Other -->
            <label class="check-card"><input type="checkbox" name="focus" value="eis" />EIS / SEIS</label>
            <label class="check-card"><input type="checkbox" name="focus" value="crypto" />Crypto</label>
            <label class="check-card"><input type="checkbox" name="focus" value="cash" />Cash / MMFs</label>
            <label class="check-card"><input type="checkbox" name="focus" value="multiAsset" />Multi-Asset Funds</label>
          </div>
          <p class="small">We show context for all focus areas; recommendations stay limited to Gold / Art / EIS.</p>
        </section>

        <!-- Risk -->
        <section class="question-group">
          <h3>Risk Profile</h3>
          <div class="pill-group" role="radiogroup" aria-label="Risk">
            <div class="pill"><input id="risk-vlow" type="radio" name="risk" value="vlow" required /><label for="risk-vlow">Very Low</label></div>
            <div class="pill"><input id="risk-low"  type="radio" name="risk" value="low"/><label for="risk-low">Low</label></div>
            <div class="pill"><input id="risk-med"  type="radio" name="risk" value="medium"/><label for="risk-med">Medium</label></div>
            <div class="pill"><input id="risk-high" type="radio" name="risk" value="high"/><label for="risk-high">High</label></div>
            <div class="pill"><input id="risk-vhigh"type="radio" name="risk" value="vhigh"/><label for="risk-vhigh">Very High</label></div>
          </div>
        </section>

        <!-- Timeline -->
        <section class="question-group">
          <h3>Timeline</h3>
          <div class="pill-group" role="radiogroup" aria-label="Timeline">
            <div class="pill"><input id="t-short" type="radio" name="timeline" value="short" required/><label for="t-short">Short 0–2y</label></div>
            <div class="pill"><input id="t-mid"   type="radio" name="timeline" value="mid"/><label for="t-mid">Mid 2–5y</label></div>
            <div class="pill"><input id="t-long"  type="radio" name="timeline" value="long"/><label for="t-long">Long 5y+</label></div>
          </div>
          <div class="input-group" style="margin-top:10px">
            <label for="timeframe">How many years do you have in mind</label>
            <input id="timeframe" name="timeframe" type="text" placeholder="e.g., 3 years, 7 to 10 years"/>
          </div>
        </section>

        <!-- Goals -->
        <section class="question-group">
          <h3>Primary Goals</h3>
          <div class="grid cols-3" role="group" aria-label="Goals">
            <label class="check-card"><input type="checkbox" name="goals" value="preserve" />Preserve Capital</label>
            <label class="check-card"><input type="checkbox" name="goals" value="income" />Generate Income</label>
            <label class="check-card"><input type="checkbox" name="goals" value="growth" />Growth</label>
            <label class="check-card"><input type="checkbox" name="goals" value="hedge" />Inflation Hedge</label>
            <label class="check-card"><input type="checkbox" name="goals" value="uncorrelated" />Uncorrelated Diversifier</label>
            <label class="check-card"><input type="checkbox" name="goals" value="tax" />Tax Efficiency</label>
          </div>
        </section>

        <!-- Experience -->
        <section class="question-group">
          <h3>Experience</h3>
          <div class="pill-group" role="radiogroup" aria-label="Experience">
            <div class="pill"><input id="exp-new" type="radio" name="experience" value="new" required /><label for="exp-new">New</label></div>
            <div class="pill"><input id="exp-int" type="radio" name="experience" value="intermediate" checked /><label for="exp-int">Intermediate</label></div>
            <div class="pill"><input id="exp-adv" type="radio" name="experience" value="advanced" /><label for="exp-adv">Advanced</label></div>
          </div>
        </section>

        <button type="submit" class="submit-btn">Get Recommendation</button>
        <div class="toolbar">
          <button type="button" id="downloadPDF" class="btn">Download PDF Report</button>
        </div>
      </form>

      <!-- Results -->
      <div id="result" class="result" aria-live="polite">
        <div id="fitSummary" class="small" style="margin-bottom:10px"></div>
        <div class="inputs-recap" id="inputsRecap"></div>
        <div class="focus-overview" id="focusOverview"></div>

        <h3 class="small" style="margin:16px 0 8px">Top recommendations (Gold, Art or EIS)</h3>
        <div class="cards" id="cards"></div>

        <!-- New: Clear Fit Levels & Rationale -->
        <div class="rationale" id="rationaleCards"></div>

        <div class="report" id="report">
          <div class="small muted" style="margin-bottom:6px">Points by factor (all assets). Rows for Gold/Art/EIS are highlighted here only.</div>
          <div style="overflow:auto">
            <table id="reportTable" aria-describedby="report">
              <thead>
                <tr>
                  <th>Asset</th>
                  <th class="right">Total</th>
                  <th class="right">Risk</th>
                  <th class="right">Timeline</th>
                  <th class="right">Income</th>
                  <th class="right">Goals/Exp.</th>
                  <th class="right">Focus</th>
                  <th class="right">Budget</th>
                </tr>
              </thead>
              <tbody id="reportBody"></tbody>
            </table>
          </div>
        </div>

        <p class="disclaimer">Only Gold, Art and EIS are recommended here. Other focus areas are shown for context. Not advice.</p>
      </div>
    </div>
  </div>

<script>
(function(){
  var form = document.getElementById('investmentForm');
  var resultEl = document.getElementById('result');
  var cardsEl = document.getElementById('cards');
  var rationaleEl = document.getElementById('rationaleCards');
  var fitSummaryEl = document.getElementById('fitSummary');
  var inputsRecapEl = document.getElementById('inputsRecap');
  var focusOverviewEl = document.getElementById('focusOverview');
  var reportBody = document.getElementById('reportBody');
  var pdfBtn = document.getElementById('downloadPDF');

  /* Expanded catalogue */
  var CATALOGUE = {
    // Traditional
    stocks:{icon:"📈",label:"Stocks"},
    bonds:{icon:"🏛️",label:"Bonds"},
    etfs:{icon:"🧺",label:"ETFs / Index"},
    dividend:{icon:"💸",label:"Dividend Equity"},
    smallCaps:{icon:"🧬",label:"Small Caps"},
    emEquity:{icon:"🌏",label:"EM Equity"},
    emDebt:{icon:"💱",label:"EM Debt"},
    reits:{icon:"🏢",label:"REITs"},
    property:{icon:"🏘️",label:"Direct Property"},
    // Alts / Private
    infrastructure:{icon:"🏗️",label:"Infrastructure"},
    renewables:{icon:"🌿",label:"Renewable Infrastructure"},
    hedgeFunds:{icon:"🧠",label:"Hedge Funds"},
    privateCredit:{icon:"💼",label:"Private Credit"},
    pe:{icon:"🤝",label:"Private Equity"},
    vc:{icon:"🚀",label:"Venture Capital"},
    structured:{icon:"📜",label:"Structured Notes"},
    // Commodities / Real assets
    commodities:{icon:"🛢️",label:"Commodities (broad)"},
    gold:{icon:"🥇",label:"Gold"},
    silver:{icon:"🥈",label:"Silver"},
    platinum:{icon:"🏅",label:"Platinum"},
    art:{icon:"🎨",label:"Art"},
    whisky:{icon:"🥃",label:"Whisky / Wine"},
    carbon:{icon:"🍃",label:"Carbon Credits"},
    // Other
    eis:{icon:"🧾",label:"EIS / SEIS"},
    crypto:{icon:"₿",label:"Crypto"},
    cash:{icon:"💷",label:"Cash / MMFs"},
    multiAsset:{icon:"🧩",label:"Multi-Asset Funds"}
  };

  /* Weights (no liquidity/preferences/wrappers) */
  var WEIGHTS = {
    risk: {
      vlow:{bonds:3,cash:3,etfs:2,gold:3,dividend:2,reits:2},
      low:{bonds:2,cash:2,etfs:2,property:1,infrastructure:1,gold:3,art:1,privateCredit:1,dividend:2,reits:2,multiAsset:2},
      medium:{etfs:3,stocks:3,property:2,infrastructure:2,renewables:2,gold:2,art:2,privateCredit:2,whisky:1,silver:1,dividend:2,reits:2,multiAsset:2},
      high:{stocks:2,pe:2,vc:3,eis:3,art:3,crypto:2,property:1,gold:1,commodities:2,hedgeFunds:2,smallCaps:2,emEquity:2,structured:2},
      vhigh:{vc:4,eis:4,pe:3,crypto:3,art:3,stocks:2,commodities:2,smallCaps:3,emEquity:3}
    },
    timeline: {
      short:{cash:3,bonds:2,gold:2,etfs:1,crypto:1,silver:1,structured:2,dividend:1},
      mid:{etfs:2,stocks:2,bonds:2,gold:1,property:2,privateCredit:2,art:2,whisky:1,eis:1,infrastructure:2,renewables:2,hedgeFunds:2,dividend:2,reits:2,structured:2,multiAsset:2},
      long:{stocks:3,property:3,art:3,pe:2,vc:2,eis:3,privateCredit:2,whisky:2,crypto:2,gold:1,commodities:2,infrastructure:3,renewables:3,hedgeFunds:2,platinum:1,smallCaps:3,emEquity:3,emDebt:2,reits:3,carbon:2}
    },
    incomeNeed: {
      none:{art:1,eis:1,gold:1},
      low:{gold:2,art:1,bonds:2,privateCredit:2,property:1,stocks:1,cash:1,infrastructure:1,hedgeFunds:1,dividend:2,reits:2,multiAsset:1},
      mid:{privateCredit:3,bonds:2,property:2,stocks:1,gold:2,infrastructure:2,renewables:2,hedgeFunds:2,dividend:3,reits:3,structured:2},
      high:{privateCredit:4,property:3,bonds:2,gold:2,hedgeFunds:2,structured:3,dividend:3}
    },
    goals: {
      preserve:{bonds:3,cash:3,gold:3,etfs:2,art:1,structured:2,multiAsset:2},
      income:{privateCredit:3,bonds:2,property:2,stocks:1,gold:2,infrastructure:2,renewables:2,hedgeFunds:2,dividend:3,reits:3,structured:2},
      growth:{stocks:3,etfs:2,art:3,property:2,pe:2,vc:2,eis:3,whisky:1,crypto:2,gold:1,commodities:2,infrastructure:2,renewables:3,smallCaps:3,emEquity:3,carbon:2},
      hedge:{gold:3,commodities:2,property:2,stocks:1,art:1,whisky:1,silver:2,platinum:2,carbon:2},
      uncorrelated:{gold:2,art:3,whisky:2,privateCredit:1,hedgeFunds:2,crypto:2,carbon:2},
      tax:{eis:4}
    },
    experience:{
      new:{bonds:2,cash:2,gold:1,etfs:2,stocks:1,multiAsset:2,dividend:2,reits:2},
      intermediate:{etfs:2,stocks:2,bonds:1,property:1,art:2,privateCredit:1,gold:1,eis:1,infrastructure:1,dividend:2,reits:2,multiAsset:2},
      advanced:{pe:1,vc:1,eis:2,crypto:1,art:2,privateCredit:1,stocks:1,gold:1,hedgeFunds:2,structured:2,smallCaps:2,emEquity:2}
    },
    focusBoost:{
      stocks:2,bonds:2,etfs:2,dividend:2,smallCaps:2,emEquity:2,emDebt:2,reits:2,property:2,
      infrastructure:2,renewables:2,hedgeFunds:2,privateCredit:2,pe:2,vc:2,structured:2,
      eis:3,crypto:2,commodities:2,gold:3,silver:2,platinum:2,art:3,whisky:2,carbon:2,cash:2,multiAsset:2
    }
  };

  var RECOMMEND_KEYS = ['gold','art','eis'];

  function getFormData(){
    var fd = new FormData(form);
    function toArray(name){
      var nodes = form.querySelectorAll('[name="'+name+'"]:checked');
      var arr = []; for (var i=0;i<nodes.length;i++) arr.push(nodes[i].value);
      return arr;
    }
    var timeframe = fd.get('timeframe');
    return {
      budget: Number(fd.get('budget') || 0),
      incomeNeed: fd.get('incomeNeed') || 'none',
      focus: toArray('focus'),
      risk: fd.get('risk') || '',
      timeline: fd.get('timeline') || '',
      timeframe: timeframe ? String(timeframe).trim() : '',
      goals: toArray('goals'),
      experience: fd.get('experience') || 'intermediate'
    };
  }

  function scoreAllDetailed(p){
    var assets = Object.keys(CATALOGUE);
    var totals = {}; var byFactor = {};
    assets.forEach(function(a){
      totals[a]=0; byFactor[a]={risk:0,timeline:0,income:0,goals:0,focus:0,budget:0};
    });
    function addRow(row, key){
      if (!row) return;
      Object.keys(row).forEach(function(a){
        var pts=row[a]||0;
        if (typeof totals[a]==='number'){ totals[a]+=pts; byFactor[a][key]+=pts; }
      });
    }
    addRow(WEIGHTS.risk[p.risk],'risk');
    addRow(WEIGHTS.timeline[p.timeline],'timeline');
    addRow(WEIGHTS.incomeNeed[p.incomeNeed],'income');
    addRow(WEIGHTS.experience[p.experience],'goals');
    (p.goals||[]).forEach(function(g){ addRow(WEIGHTS.goals[g],'goals'); });
    (p.focus||[]).forEach(function(f){
      var pts = WEIGHTS.focusBoost[f]||0;
      if (typeof totals[f]==='number'){ totals[f]+=pts; byFactor[f].focus+=pts; }
    });
    if (p.budget>0 && p.budget<10000){
      ['gold','cash','bonds','etfs','silver'].forEach(function(a){ if (typeof totals[a]==='number'){ totals[a]+=1; byFactor[a].budget+=1; }});
    }
    if (p.budget>=100000){
      ['art','eis','privateCredit','infrastructure','renewables','hedgeFunds','pe','structured'].forEach(function(a){ if (typeof totals[a]==='number'){ totals[a]+=1; byFactor[a].budget+=1; }});
    }
    return {totals:totals, byFactor:byFactor};
  }

  function topN(score, keys, n){
    n = n || 3;
    var arr=[]; keys.forEach(function(k){ if (typeof score[k]==='number') arr.push([k,score[k]]); });
    arr.sort(function(a,b){ if (b[1]!==a[1]) return b[1]-a[1]; return a[0].localeCompare(b[0]); });
    return arr.slice(0,n).filter(function(x){ return x[1]>0; });
  }

  function explainGAE(asset, p){
    var lines=[], g=new Set(p.goals||[]);
    if (asset==='gold'){
      if (['vlow','low'].indexOf(p.risk)>=0) lines.push("Lower risk tolerance points to stability.");
      if (g.has('hedge')) lines.push("Inflation hedge objective aligns with gold.");
      if (g.has('uncorrelated')) lines.push("Diversifier vs traditional assets.");
      if (['short','mid'].includes(p.timeline)) lines.push("Better liquidity than many alternatives.");
    }
    if (asset==='art'){
      if (['medium','high','vhigh'].indexOf(p.risk)>=0) lines.push("Comfort with volatility supports growth-oriented art exposure.");
      if (p.timeline==='long') lines.push("Longer horizon suits art’s illiquidity and career cycles.");
      if (g.has('uncorrelated')) lines.push("Low correlation aids diversification.");
      if (g.has('growth')) lines.push("Targets capital appreciation.");
    }
    if (asset==='eis'){
      if (g.has('tax')) lines.push("Tax efficiency goal maps to EIS reliefs (subject to rules).");
      if (['high','vhigh'].indexOf(p.risk)>=0) lines.push("Higher risk tolerance matches early-stage exposure.");
      if (p.timeline!=='short') lines.push("Holding period requirements fit medium to long timelines.");
      if (p.incomeNeed==='none') lines.push("No income need suits return profile focused on capital growth/reliefs.");
    }
    if ((p.focus||[]).indexOf(asset)>=0) lines.push("Selected as a focus area.");
    if (!lines.length) lines.push("Matches risk, timeline, income need and goals.");
    return lines;
  }

  function cautionsGAE(asset, p){
    var notes=[];
    if (asset==='gold'){
      if (p.goals && p.goals.includes('income')) notes.push("Gold is not a natural income generator.");
      if (p.timeline==='long') notes.push("Long horizons may favour growth assets over static hedges.");
    }
    if (asset==='art'){
      if (['vlow','low'].includes(p.risk)) notes.push("Art volatility/illiquidity may feel uncomfortable at low risk levels.");
      if (['short'].includes(p.timeline)) notes.push("Short timelines conflict with typical art liquidity.");
    }
    if (asset==='eis'){
      if (['vlow','low','medium'].includes(p.risk)) notes.push("EIS carries high risk of loss; ensure capacity for risk.");
      if (p.incomeNeed!=='none') notes.push("EIS is not designed for income distributions.");
    }
    return notes;
  }

  function renderInputsRecap(p){
    function fmt(arr){ return (arr && arr.length) ? arr.join(", ") : "None selected"; }
    inputsRecapEl.innerHTML =
      '<div class="small" style="margin-bottom:6px"><strong>Inputs</strong></div>'+
      '<ul>'+
        '<li>Risk: <strong>'+(p.risk||'n/a')+'</strong> | Timeline: <strong>'+(p.timeline||'n/a')+'</strong> '+(p.timeframe?('('+p.timeframe+')'):'')+'</li>'+
        '<li>Income need: <strong>'+(p.incomeNeed||'none')+'</strong> | Budget: <strong>£'+Intl.NumberFormat('en-GB').format(p.budget||0)+'</strong></li>'+
        '<li>Goals: '+fmt(p.goals)+'</li>'+
        '<li>Focus areas: '+fmt(p.focus)+'</li>'+
        '<li>Experience: '+(p.experience||'n/a')+'</li>'+
      '</ul>';
  }

  function renderFocusOverview(p, totals){
    var nonGAE = (p.focus||[]).filter(function(k){ return RECOMMEND_KEYS.indexOf(k)<0; });
    if (!nonGAE.length){ focusOverviewEl.innerHTML=''; return; }
    var tags = nonGAE.map(function(k){
      var item = CATALOGUE[k], pts = totals[k]||0;
      return '<span class="tag">'+item.icon+' '+item.label+' · '+pts+' pts</span>';
    }).join('');
    focusOverviewEl.innerHTML = '<div class="small"><strong>Focus overview</strong> (context only)</div><div>'+tags+'</div>';
  }

  function renderRecommendations(p, totals){
    var picks = topN(totals, RECOMMEND_KEYS, 3);
    cardsEl.innerHTML = '';
    if (!picks.length){
      cardsEl.innerHTML = '<div class="small">No clear Gold, Art or EIS match. Adjust risk, timeline or goals.</div>';
      return;
    }
    var maxScore = Math.max.apply(null, RECOMMEND_KEYS.map(function(k){ return totals[k]||0; }));
    picks.forEach(function(tuple){
      var key = tuple[0], s = tuple[1];
      var pct = Math.round((s / (maxScore||1))*100);
      var cat = CATALOGUE[key];
      var barClass = pct>=66 ? 'good' : (pct>=40 ? 'mid' : 'low');
      var why = explainGAE(key, p).map(function(x){ return '<li>'+x+'</li>'; }).join('');
      var desc = {gold:"Gold may provide stability and a portfolio hedge when sized appropriately.",
                  art:"Art offers long-term appreciation potential and diversification. Selection is key.",
                  eis:"EIS can deliver strong tax benefits and upside with higher inherent risk and holding periods."}[key];
      var card = document.createElement('div');
      card.className='investment-card';
      card.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:center">'+
        '  <span class="badge"><span class="icon">'+cat.icon+'</span> <strong>'+cat.label+'</strong></span>'+
        '  <span class="badge"><strong>'+s+'</strong> pts</span>'+
        '</div>'+
        '<div class="progress"><div class="bar '+barClass+'" style="width:'+pct+'%"></div></div>'+
        '<p class="small" style="margin:6px 0 4px">'+desc+'</p>'+
        '<ul class="list">'+why+'</ul>';
      cardsEl.appendChild(card);
    });
  }

  // New: Dedicated rationale cards with fit percentage + reasons + considerations
  function renderRationale(p, totals, byFactor){
    var maxGAE = Math.max.apply(null, RECOMMEND_KEYS.map(k=>totals[k]||0)) || 1;
    var html = RECOMMEND_KEYS.map(function(k){
      var s = totals[k]||0;
      var pct = Math.round((s/maxGAE)*100);
      var reasons = explainGAE(k,p).map(x=>'<li>'+x+'</li>').join('') || '<li>General alignment across factors.</li>';
      var cons = cautionsGAE(k,p).map(x=>'<li>'+x+'</li>').join('') || '<li>No specific cautions from inputs.</li>';
      var f = byFactor[k] || {risk:0,timeline:0,income:0,goals:0,focus:0,budget:0};
      return '<div class="card-lite">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'+
        '  <span class="badge">'+CATALOGUE[k].icon+' <strong>'+CATALOGUE[k].label+'</strong></span>'+
        '  <span class="badge"><strong>'+pct+'%</strong> fit · '+s+' pts</span>'+
        '</div>'+
        '<div class="small muted">Factor breakdown — Risk '+f.risk+', Timeline '+f.timeline+', Income '+f.income+', Goals/Exp. '+f.goals+', Focus '+f.focus+', Budget '+f.budget+'</div>'+
        '<div class="small" style="margin-top:6px"><strong>Reasons for fit</strong></div>'+
        '<ul class="list">'+reasons+'</ul>'+
        '<div class="small" style="margin-top:6px"><strong>Considerations</strong></div>'+
        '<ul class="list">'+cons+'</ul>'+
      '</div>';
    }).join('');
    rationaleEl.innerHTML = html;
  }

  function renderReport(detailed){
    var totals = detailed.totals, byFactor = detailed.byFactor;
    var rows = Object.keys(CATALOGUE).map(function(asset){
      var f = byFactor[asset], t = totals[asset]||0;
      return {asset:asset, label:CATALOGUE[asset].label, total:t,
              risk:f.risk, timeline:f.timeline, income:f.income,
              goals:f.goals, focus:f.focus, budget:f.budget};
    }).sort(function(a,b){ if (b.total!==a.total) return b.total-a.total; return a.label.localeCompare(b.label); });

    function fmt(n){ return (n===0 ? '0' : String(n)); }
    reportBody.innerHTML = rows.map(function(r){
      var hl = RECOMMEND_KEYS.indexOf(r.asset)>=0 ? ' class="hl"' : '';
      return '<tr'+hl+'>'+
        '<td>'+CATALOGUE[r.asset].icon+' '+r.label+'</td>'+
        '<td class="right mono"><strong>'+fmt(r.total)+'</strong></td>'+
        '<td class="right mono">'+fmt(r.risk)+'</td>'+
        '<td class="right mono">'+fmt(r.timeline)+'</td>'+
        '<td class="right mono">'+fmt(r.income)+'</td>'+
        '<td class="right mono">'+fmt(r.goals)+'</td>'+
        '<td class="right mono">'+fmt(r.focus)+'</td>'+
        '<td class="right mono">'+fmt(r.budget)+'</td>'+
      '</tr>';
    }).join('');
  }

  function validateBasic(){
    return !!(form.querySelector('[name="risk"]:checked') && form.querySelector('[name="timeline"]:checked'));
  }

  function buildReportHTML(payload, detailed){
    var totals = detailed.totals, byFactor = detailed.byFactor;
    var picks = topN(totals, RECOMMEND_KEYS, 3);
    function fmtList(arr){ return (arr && arr.length) ? arr.join(', ') : 'None'; }
    function fmtGBP(n){ return '£'+Intl.NumberFormat('en-GB').format(n||0); }
    var rows = Object.keys(CATALOGUE).map(function(asset){
      var f = byFactor[asset], t = totals[asset]||0;
      return '<tr>'+
        '<td>'+CATALOGUE[asset].icon+' '+CATALOGUE[asset].label+'</td>'+
        '<td class="r"><strong>'+t+'</strong></td>'+
        '<td class="r">'+f.risk+'</td>'+
        '<td class="r">'+f.timeline+'</td>'+
        '<td class="r">'+f.income+'</td>'+
        '<td class="r">'+f.goals+'</td>'+
        '<td class="r">'+f.focus+'</td>'+
        '<td class="r">'+f.budget+'</td>'+
      '</tr>';
    }).join('');
    var rationaleBlocks = RECOMMEND_KEYS.map(function(k){
      var s = totals[k]||0;
      var maxGAE = Math.max.apply(null, RECOMMEND_KEYS.map(key=>totals[key]||0)) || 1;
      var pct = Math.round((s/maxGAE)*100);
      var reasons = explainGAE(k,payload).map(x=>'<li>'+x+'</li>').join('') || '<li>General alignment across factors.</li>';
      var cons = cautionsGAE(k,payload).map(x=>'<li>'+x+'</li>').join('') || '<li>No specific cautions from inputs.</li>';
      var f = byFactor[k] || {risk:0,timeline:0,income:0,goals:0,focus:0,budget:0};
      return '<div class="card"><div class="row"><div class="badge">'+CATALOGUE[k].icon+' <strong>'+CATALOGUE[k].label+
             '</strong></div><div class="badge"><strong>'+pct+'%</strong> fit · '+s+' pts</div></div>'+
             '<div class="muted">Factors — Risk '+f.risk+', Timeline '+f.timeline+', Income '+f.income+', Goals/Exp. '+f.goals+', Focus '+f.focus+', Budget '+f.budget+'</div>'+
             '<div style="margin-top:6px"><strong>Reasons for fit</strong><ul>'+reasons+'</ul></div>'+
             '<div style="margin-top:6px"><strong>Considerations</strong><ul>'+cons+'</ul></div>'+
             '</div>';
    }).join('');
    var recCards = picks.map(function(pair){
      var key=pair[0], s=pair[1];
      var why = explainGAE(key, payload).map(function(x){return '<li>'+x+'</li>';}).join('');
      return '<div class="card"><div class="row"><div class="badge">'+CATALOGUE[key].icon+' <strong>'+CATALOGUE[key].label+
             '</strong></div><div class="badge"><strong>'+s+'</strong> pts</div></div><ul>'+why+'</ul></div>';
    }).join('');
    var now = new Date();
    var dateStr = now.toLocaleString('en-GB',{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    return '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
      '<title>DPR Client Report</title>'+
      '<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;color:#1f2937;margin:0;padding:24px;background:#f7f8fb}'+
      '.wrap{max-width:900px;margin:0 auto}.cover{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;border-radius:20px;padding:28px 24px;margin-bottom:18px}'+
      '.cover h1{margin:0 0 6px;font-weight:300}.cover .meta{opacity:.9;font-size:.95rem}.section{background:#fff;border:1px solid #eef1f5;border-radius:14px;padding:16px;margin:12px 0}'+
      '.row{display:flex;gap:12px;align-items:center;justify-content:space-between}.badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #e6e8ef;border-radius:999px;background:#fff;font-size:.9rem}'+
      '.muted{color:#6b7280}.grid{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}@media (max-width:820px){.grid{grid-template-columns:1fr}}'+
      '.card{background:#fff;border:1px solid #eef1f5;border-radius:12px;padding:12px}table{width:100%;border-collapse:collapse;font-size:.92rem}'+
      'th,td{border-bottom:1px solid #f0f2f7;padding:8px 10px;text-align:left;white-space:nowrap}thead th{background:#f4f6fb}.r{text-align:right;font-family:ui-monospace,Menlo,Consolas,monospace}'+
      '@media print{body{background:#fff;padding:0}.section{page-break-inside:avoid}.cover{border-radius:0}}</style></head><body>'+
      '<div class="wrap"><div class="cover"><h1>De Pointe Research — Client Report</h1><div class="meta">Generated: '+dateStr+
      '</div><div class="meta">Note: For information only. Not investment advice.</div></div>'+
      '<div class="section"><h3>Inputs</h3><ul>'+
      '<li>Risk: <strong>'+(payload.risk||'n/a')+'</strong> | Timeline: <strong>'+(payload.timeline||'n/a')+'</strong> '+(payload.timeframe?('('+payload.timeframe+')'):'')+'</li>'+
      '<li>Income need: <strong>'+(payload.incomeNeed||'none')+'</strong> | Budget: <strong>'+fmtGBP(payload.budget||0)+'</strong></li>'+
      '<li>Goals: '+fmtList(payload.goals)+'</li>'+
      '<li>Focus areas (context): '+fmtList(payload.focus)+'</li>'+
      '<li>Experience: '+(payload.experience||'n/a')+'</li>'+
      '</ul></div>'+
      '<div class="section"><h3>Fit levels & rationale (Gold, Art, EIS)</h3>'+rationaleBlocks+'</div>'+
      '<div class="section"><h3>Weighting Report (all assets)</h3><p class="muted">Points by factor. G/A/E rows are not specially highlighted in this client file.</p>'+
      '<div style="overflow:auto"><table><thead><tr><th>Asset</th><th class="r">Total</th><th class="r">Risk</th><th class="r">Timeline</th><th class="r">Income</th><th class="r">Goals/Exp.</th><th class="r">Focus</th><th class="r">Budget</th></tr></thead>'+
      '<tbody>'+rows+'</tbody></table></div></div>'+
      '<div class="section"><p class="muted">This report is illustrative and not investment advice. Any tax reliefs (e.g., EIS) depend on legislation and personal circumstances.</p></div>'+
      '</div><script>setTimeout(function(){try{window.print()}catch(e){}},300)<\/script></body></html>';
  }

  form.addEventListener('submit', function(e){
    e.preventDefault();
    if (!validateBasic()){ alert('Please select both Risk and Timeline.'); return; }
    var payload = getFormData();
    var detailed = scoreAllDetailed(payload);

    renderInputsRecap(payload);
    renderFocusOverview(payload, detailed.totals);
    fitSummaryEl.textContent = "Recommendations are limited to Gold, Art or EIS. Focus choices are included for context.";
    renderRecommendations(payload, detailed.totals);
    renderRationale(payload, detailed.totals, detailed.byFactor);
    renderReport(detailed);

    resultEl.classList.add('show');
    resultEl.scrollIntoView({behavior:'smooth', block:'start'});

    form.setAttribute('data-lastPayload', JSON.stringify(payload));
    form.setAttribute('data-lastDetailed', JSON.stringify(detailed));
  });

  function validateBasic(){
    return !!(form.querySelector('[name="risk"]:checked') && form.querySelector('[name="timeline"]:checked'));
  }

  /* ----- PDF download ----- */
  function extractBodyHTML(fullHtml){
    var s = fullHtml.indexOf('<body>');
    var e = fullHtml.lastIndexOf('</body>');
    return (s !== -1 && e !== -1) ? fullHtml.slice(s + 6, e) : fullHtml;
  }
  pdfBtn.addEventListener('click', function(){
    var p = form.getAttribute('data-lastPayload');
    var d = form.getAttribute('data-lastDetailed');
    var payload = p ? JSON.parse(p) : getFormData();
    var detailed = d ? JSON.parse(d) : scoreAllDetailed(payload);
    var fullHtml = buildReportHTML(payload, detailed);
    var bodyHtml = extractBodyHTML(fullHtml);

    var wrap = document.createElement('div');
    wrap.style.position='fixed';
    wrap.style.left='-10000px';
    wrap.style.top='0';
    wrap.style.width='800px';
    wrap.style.background='#fff';
    wrap.innerHTML = bodyHtml;
    document.body.appendChild(wrap);

    if (typeof html2pdf !== 'undefined'){
      html2pdf()
        .set({
          margin: 10,
          filename: 'DPR-Client-Report.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        })
        .from(wrap)
        .save()
        .then(function(){ wrap.remove(); });
    } else {
      var w = window.open('', '_blank');
      if (w){ w.document.open(); w.document.write(fullHtml); w.document.close(); }
      else { alert('Popup blocked. Please allow popups and try again.'); }
    }
  });

})();
</script>

<!-- html2pdf bundle -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
  integrity="sha512-YcsIPvn+6g1xtEex2vY2bQ4H/4S7A6Q0WbRjeF3qfB9q6Kx1+M2mPzTq7cJ8rZUiTTW2u3lW9gYk9vC8C+1P0A=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
</body>
</html>
